Documentation - Workers
====================

After [queues are configured](2.Configuration.md), [jobs classes are written](3.Jobs.md) and pushed into a queue, they
must be popped out by a worker to be executed. This is done, as explained in the [introduction](1.Introduction.md), by
workers. A worker for SlmQueue is a class implementing the `SlmQueue\Worker\WorkerInterface`.

A worker is started by by calling its `processQueue($queue, array $options = array())` method. The `$queue` parameter is
a string and should be the service name of the queue as registered in the queue plugin manager. The `$options` parameter
is an optional array which is directly passed on to the `pop()` method of the queue. This can contain flags specifically
for the different queue implementations.

Worker stop conditions
----------------------

The worker will be a long running call, due to the `while (...) { /*...*/ }` loop it
contains inside the `processQueue()` method. However, there are reasons to cancel the loop and stop the worker to
continue. PHP is not the best language for creating infinite running scripts.

It is wise to abort the script frequently, for example after x number of cycles in the `while` loop. Be sure to have 
some system that restart the worker (e. g. systemd or supervisord see [7. Worker management](7.WorkerManagement.md))

Various build-in strategies (['see 6.Events'](6.Events.md)) are used to decide if the worker should exit. These
strategies are aggregate listeners that hook into events the worker dispatches. A listener (to 'process.queue' or 
'process.idle') may shortcut the event flow simply be returning a `ExitWorkerLoopResult::withReason('a reason')`. The
worker will inspect the response collection.

If you want to run a worker for a long time (or to determine the frequency of the restart) you have to take into account
all open connections to external systems.

Some examples:
- the database server (e. g. MySQL) may close the connection
  - possible error message: "MySQL has gone away"
  - see "connect_timeout", "wait_timeout" and "interactive-timeout" options in MySQL, they all default to 8 hours
  - You can use [BsbDoctrineReconnect](https://github.com/bushbaby/BsbDoctrineReconnect) to automatically reconnect doctrine
- SMTP servers are known to close connections if they are open / idle too long
  - see [Postfix: smtp_connection_reuse_time_limit](http://www.postfix.org/postconf.5.html#smtp_connection_reuse_time_limit), default is 5 minutes

In order to fix these problems you could stop reusing the same connection and open/close a new connection for each 
new job. This will increase the overhead significantly, which may be inaccaptable (especially under high pressure 
situations with a number of jobs requring external connections).

If you want to keep reusing the connection with long running workers you may need some ability to auto-reconnect these 
external system.

Our suggestion is using auto-reconnecting external connections and a time-based restart of the worker.

Command line utility
--------------------

SlmQueue provides integration with the Zend Framework console routes and ease the use of workers. You can start a
worker for e.g. the beanstalkd queue system by running the following command*:

```php
php public/index.php queue beanstalkd <queue-name>
```

*) assumed here is your working directory is the application root and your application is structured like the Zend
Skeleton Application with public directory and an `index.php` file.

This CLI command dispatches a SlmQueue controller. A worker is injected into the controller and it simply calls the
worker's `processQueue()` method. Every queue implementation has it's own CLI command so read the documentation for
these implementations for the exact command.

Navigation
----------

Previous page: [Queue Aware](4.QueueAware.md)
Next page: [Events](6.Events.md)

1. [Introduction](1.Introduction.md)
2. [Configuration](2.Configuration.md)
3. [Jobs](3.Jobs.md)
4. [QueueAware](4.QueueAware.md)
5. [Workers](5.Workers.md)
6. [Events](6.Events.md)
7. [Worker management](7.WorkerManagement.md)
